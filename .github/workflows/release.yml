name: Release

on:
  release:
    types: [published]

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  ##############################################################################
  # 1)  Linux  –  Clang / Ninja
  ##############################################################################
  linux-release:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - name: Linux (Clang) (x64-linux)
            triplet: x64-linux
            runner: ubuntu-latest
            preset: linux-release-vcpkg
            archive: omath-linux-x64
            install_cmd: |
              wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | sudo tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
              sudo add-apt-repository -y "deb http://apt.llvm.org/noble/ llvm-toolchain-noble-21 main"
              sudo apt-get update
              sudo apt-get install -y git build-essential cmake ninja-build \
                     zip unzip curl pkg-config ca-certificates \
                     clang-21 lld-21 libc++-21-dev libc++abi-21-dev
              sudo update-alternatives --install /usr/bin/cc cc /usr/bin/clang-21 100
              sudo update-alternatives --install /usr/bin/c++ c++ /usr/bin/clang++-21 100
              sudo update-alternatives --install /usr/bin/lld lld /usr/bin/lld-21 100
          - name: Linux (Clang) (arm64-linux)
            triplet: arm64-linux
            runner: ubuntu-24.04-arm
            preset: linux-release-vcpkg-arm64
            archive: omath-linux-arm64
            install_cmd: |
              wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | sudo tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
              sudo add-apt-repository -y "deb http://apt.llvm.org/noble/ llvm-toolchain-noble-21 main"
              sudo apt-get update
              sudo apt-get install -y git build-essential cmake ninja-build \
                     zip unzip curl pkg-config ca-certificates \
                     clang-21 lld-21 libc++-21-dev libc++abi-21-dev
              sudo update-alternatives --install /usr/bin/cc cc /usr/bin/clang-21 100
              sudo update-alternatives --install /usr/bin/c++ c++ /usr/bin/clang++-21 100
              sudo update-alternatives --install /usr/bin/lld lld /usr/bin/lld-21 100
      fail-fast: false
    env:
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg
    steps:
      - name: Install basic tool-chain
        shell: bash
        run: ${{ matrix.install_cmd }}

      - name: Checkout repository (with sub-modules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up vcpkg
        shell: bash
        run: |
          git clone https://github.com/microsoft/vcpkg "$VCPKG_ROOT"
          cd "$VCPKG_ROOT"
          ./bootstrap-vcpkg.sh

      - name: Configure (cmake --preset)
        shell: bash
        run: |
          cmake --preset ${{ matrix.preset }} \
            -DVCPKG_INSTALL_OPTIONS="--allow-unsupported" \
            -DOMATH_BUILD_TESTS=OFF \
            -DOMATH_BUILD_BENCHMARK=OFF \
            -DVCPKG_MANIFEST_FEATURES="imgui;avx2"

      - name: Build
        shell: bash
        run: cmake --build cmake-build/build/${{ matrix.preset }} --target omath

      - name: Install
        shell: bash
        run: cmake --install cmake-build/build/${{ matrix.preset }} --prefix staging

      - name: Package
        shell: bash
        run: tar -czf ${{ matrix.archive }}.tar.gz -C staging .

      - name: Upload release asset
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: gh release upload "${{ github.event.release.tag_name }}" "${{ matrix.archive }}.tar.gz" --clobber

  ##############################################################################
  # 2)  Windows  –  MSVC / Ninja
  ##############################################################################
  windows-release:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - name: Windows (MSVC) (x64-windows)
            runner: windows-latest
            arch: amd64
            preset: windows-release-vcpkg
            triplet: x64-windows
            archive: omath-windows-x64
          - name: Windows (MSVC) (x86-windows)
            runner: windows-latest
            arch: amd64_x86
            preset: windows-release-vcpkg-x86
            triplet: x86-windows
            archive: omath-windows-x86
          - name: Windows (MSVC) (arm64-windows)
            runner: windows-11-arm
            arch: arm64
            preset: windows-release-vcpkg-arm64
            triplet: arm64-windows
            archive: omath-windows-arm64
      fail-fast: false
    env:
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg
    steps:
      - name: Checkout repository (with sub-modules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Ninja
        uses: seanmiddleditch/gha-setup-ninja@v4

      - name: Set up MSVC developer command-prompt
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch }}

      - name: Configure (cmake --preset)
        shell: bash
        run: |
          cmake --preset ${{ matrix.preset }} \
            -DOMATH_BUILD_TESTS=OFF \
            -DOMATH_BUILD_BENCHMARK=OFF \
            -DVCPKG_MANIFEST_FEATURES="imgui;avx2"

      - name: Build
        shell: bash
        run: cmake --build cmake-build/build/${{ matrix.preset }} --target omath

      - name: Install
        shell: bash
        run: cmake --install cmake-build/build/${{ matrix.preset }} --prefix staging

      - name: Package
        shell: pwsh
        run: Compress-Archive -Path staging\* -DestinationPath "${{ matrix.archive }}.zip"

      - name: Upload release asset
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: gh release upload "${{ github.event.release.tag_name }}" "${{ matrix.archive }}.zip" --clobber

  ##############################################################################
  # 3)  macOS  –  AppleClang / Ninja
  ##############################################################################
  macos-release:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - name: macOS (AppleClang) (arm64-osx)
            runner: macos-latest
            preset: darwin-release-vcpkg
            triplet: arm64-osx
            archive: omath-macos-arm64
          - name: macOS (AppleClang) (x64-osx)
            runner: macos-15-intel
            preset: darwin-release-vcpkg-x64
            triplet: x64-osx
            archive: omath-macos-x64
      fail-fast: false
    env:
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg
    steps:
      - name: Install basic tool-chain with Homebrew
        shell: bash
        run: |
          brew install cmake ninja

      - name: Checkout repository (with sub-modules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up vcpkg
        shell: bash
        run: |
          git clone https://github.com/microsoft/vcpkg "$VCPKG_ROOT"

      - name: Configure (cmake --preset)
        shell: bash
        run: |
          cmake --preset ${{ matrix.preset }} \
            -DOMATH_BUILD_TESTS=OFF \
            -DOMATH_BUILD_BENCHMARK=OFF \
            -DVCPKG_MANIFEST_FEATURES="imgui;avx2"

      - name: Build
        shell: bash
        run: cmake --build cmake-build/build/${{ matrix.preset }} --target omath

      - name: Install
        shell: bash
        run: cmake --install cmake-build/build/${{ matrix.preset }} --prefix staging

      - name: Package
        shell: bash
        run: tar -czf ${{ matrix.archive }}.tar.gz -C staging .

      - name: Upload release asset
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: gh release upload "${{ github.event.release.tag_name }}" "${{ matrix.archive }}.tar.gz" --clobber
